package com.android.remotemanager.plugins;
import java.util.ArrayList;
import com.android.remotemanager.NetworkStatusMonitor;
import com.android.remotemanager.plugins.xmpp.*;
import org.jivesoftware.smack.*;
import org.jivesoftware.smack.filter.PacketFilter;
import org.jivesoftware.smack.packet.*;
import org.jivesoftware.smack.ConnectionListener;
import org.jivesoftware.smack.provider.*;
import org.xmlpull.v1.XmlPullParser;

import android.content.Context;
import android.os.Bundle;
import android.os.Handler;
import android.os.HandlerThread;
import android.os.Message;
import android.provider.VoicemailContract;
import android.util.Log;

public class XmppClient implements NetworkStatusMonitor.NetworkStatusReport{
    
    public static int XMPPCLIENT_EVENT_CONNECTION_BEFORE_CREATED = 0;
    public static int XMPPCLIENT_EVENT_CONNECT = 1;
    public static int XMPPCLIENT_EVENT_LOGIN   = 2;
    public static int XMPPCLIENT_EVENT_CONNECTION = 3;
    
    public static  int CMD_START = 0;
    public static  int CMD_CONNECT = 1;
    public static  int CMD_LOGIN = 2;
    public static  int CMD_LOGOUT = 3;
    public static  int CMD_QUIT = 4;
    
    interface XmppClientCallback(){
        public Object reportXMPPClientEvent(int xmppClientEvent, Object...args);
    }
    
    
    static private String TAG ="XmppClient";
    
    static public final String XMPP_NAMESPACE = "com.zm.epad.xmpp";
    static public final String XMPP_RMDEVICE = "remotedevice";
    static public final String XMPP_RMPACKAGE= "remotepackage";
    
    static private XmppClient mXmppClient = null;
    
    static private SmackAndroid  mSmackAndroid = null;
  /*  private PacketListener  mSmackPktListener = null;
    private ConnectionListener  mSmackConnectionListener = null;
    private IQProvider mIQProvider = null;  */
    
    
    
    @Override
    public void reportNetworkStatus(boolean bConnected) {
        
        
    }
    @Override
    public void reportXMPPConnectionStatus(int type,boolean bConnected){
        
    }
    
    static public void  initializeXMPPEnvironment(Context context){
        if(mSmackAndroid == null){
            mSmackAndroid = SmackAndroid.init(context);
        }
        return ;
    }
    static public void destroyXMPPEnvironment(){
        if(mSmackAndroid != null){
            mSmackAndroid.onDestroy();
            mSmackAndroid = null;
        }
        return;
    }
    
    
    private class XmppClientThreadHandler extends Handler{
        @Override
        public void handleMessage(Message msg) {
             int cmd = msg.what;
             if(cmd == CMD_START){
                 if(mConnectionConfiguration == null){
                     mConnectionConfiguration = (ConnectionConfiguration)
                        mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_CONNECTION_BEFORE_CREATED);
                     if(mConnectionConfiguration == null){
                         mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_CONNECT, false);
                         return;
                     }
                 }
                 
                 try {
                     mXmppConnection = new XMPPConnection(mConnectionConfiguration);
                     mXmppConnection.connect();
                     mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_CONNECT, true,
                             mXmppConnection,ProviderManager.getInstance());
                } catch (Exception e) {
                    mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_CONNECT, false);
                }
                 return;
             }else if(cmd == CMD_LOGIN){
                 if(mXmppClient == null){
                     mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_LOGIN,false);
                     return;
                 }
                 Bundle data = msg.getData();
                 String usrName = data.getString("username");
                 String usrPwd = data.getString("password");
                 String usrResource = data.getString("resource");
                 if(usrResource == null){
                     usrResource = "zhimotech";
                 }
                 try {
                     mXmppConnection.login(usrName, usrPwd, usrResource);
                     mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_LOGIN,true,mXmppConnection);
                } catch (Exception e) {
                    mXmppClientCallback.reportXMPPClientEvent(XMPPCLIENT_EVENT_LOGIN,false);
                }
             }
             
             
        }


  
    }
    
    private XmppClientThreadHandler mXmppClientHandler = null;
    private HandlerThread  mXmppHandlerThread = null;
    private Context mContext;
    private XmppClientCallback mXmppClientCallback;
    private ConnectionConfiguration  mConnectionConfiguration = null;
    private Connection mXmppConnection = null;

    public void XmppClient(Context context, XmppClientCallback xmppClientCallback){
        mContext = context;
        mXmppClientCallback = xmppClientCallback;
        
        
    }
    
    public void start(){
        if(mXmppClientHandler != null)
            return;
        mXmppHandlerThread = new HandlerThread(TAG);
        mXmppHandlerThread.start();
        mXmppClientHandler = new Handler(workThread.getLooper());
        mXmppClientHandler.sendEmptyMessage(CMD_START);
    }
    public void stop(){
        if(mXmppClientHandler == null)
            return;
        synchronized (mXmppHandlerThread) {
            mXmppHandlerThread.quit();
            mXmppHandlerThread.join();
        }
        mXmppHandlerThread = null;
        mXmppClientHandler = null;
    }
    
    public void login()
    
    
    
   /* private XmppClient(Context context){
        Log.e(TAG,"XmppClient initilize SmackAndroid ");
        mSmackAndroid = SmackAndroid.init(context);
        mIQProvider = new XmppIQProvider();
        
        ProviderManager.getInstance().addIQProvider(XMPP_RMDEVICE, XMPP_NAMESPACE,mIQProvider);
        ProviderManager.getInstance().addIQProvider(XMPP_RMPACKAGE, XMPP_NAMESPACE,mIQProvider);
        
    }*/
   /* class XmppIQProvider implements IQProvider{
        @Override
        public IQ parseIQ(XmlPullParser parser){
            String elementName = parser.getName();
            String namespace = parser.getNamespace();
            Log.e(TAG, "element: " + elementName + " namespace: " + namespace);
            if(namespace.equals(XMPP_NAMESPACE) == false){
                return null;
            }
            if(elementName.equals(XMPP_RMDEVICE)){
                RemoteDeviceIQ remoteDeviceIQ = new RemoteDeviceIQ();
                
                if(remoteDeviceIQ.parse(parser) == false)
                    return null;
                
                return remoteDeviceIQ;
            }else if (elementName.equals(XMPP_RMPACKAGE)){
                RemotePackageIQ remotePackageIQ = new RemotePackageIQ();
                
                if(remotePackageIQ.parse(parser) == false)
                    return null;
                
                return remotePackageIQ;
                
            }
            else
                return null;
         }
    }*/
    
   
    
    
   /* public void destroy(){
        if(mXmppConnection != null)
            logout();
        mSmackAndroid.onDestroy();
    }*/
  /*  public boolean connectToserver(String serverName){
        try {
            Log.e(TAG,"connectToserver " + serverName);
            Connection.DEBUG_ENABLED = true;
            mXmppConnection = new XMPPConnection(serverName, null);
            mXmppConnection.connect();
            //mSmackConnectionListener = new XmppConnectionListener();
            mXmppConnection.addConnectionListener(mSmackConnectionListener);
            return true;
        } catch (XMPPException e) {
            Log.e(TAG, e.getMessage());
            mXmppConnection = null;
            return false;
        }
    }
    
    public boolean logout(){
        if(mXmppConnection == null)
            return true;
            
        try {
                Log.e(TAG,"logout");
                mXmppConnection.disconnect();
                mXmppConnection = null;
            } catch (Exception e) {
                Log.e(TAG,"logout " + e.getMessage());
                return false;
        }
        return true;
    }
    public boolean loginToServer(String username, String password){
        if(mXmppConnection == null)
            return false;
        boolean bConnected = mXmppConnection.isConnected();
        try {
            if(bConnected == false){
                mXmppConnection.connect();
                bConnected = true;
            }
            Log.e(TAG,"login as " + username + " password " + password);
            mXmppConnection.login(username, password);
            Log.e(TAG,"login successed");
            return true;
        } catch (Exception e) {
            Log.e(TAG, e.getMessage());
            if(bConnected == false){
                //connection is not establised. release XMPPConnection/
                mXmppConnection = null;
            }
            return false;
        }
       
    }
    
      class XmppPacketListener implements PacketListener{

        @Override
        public void processPacket(Packet packet) {
            Log.e(TAG, "received a xmpp packet " + packet.toXML());
            
            if(packet.getXmlns().contains(XMPP_NAMESPACE) == false)
                return;
            
            if(packet instanceof RemotePackageIQ){
                RemotePackageIQ remotePackageIQ = (RemotePackageIQ)packet; 
                handleIQCmd(remotePackageIQ);
                
            }else if(packet instanceof RemoteDeviceIQ){
                RemoteDeviceIQ remoteDeviceIQ = (RemoteDeviceIQ)packet;
                handleIQCmd(remoteDeviceIQ);
                
            }
            
        }
        
    }
    
    
    private void handleIQCmd(RemotePackageIQ remotePackageIQ){
        int cmdType = remotePackageIQ.getCmdType();
        ArrayList<String> cmdArgs = remotePackageIQ.getCmdArgs();
        switch (cmdType) {
        case RemotePackageIQ.CMD_INT_ENABLE:{
              String pkgName = cmdArgs.get(0);
              Log.e(TAG, "enable pkg: " + pkgName);
              boolean bResult = mRPM.enablePkgForUser(pkgName,0);
              Packet resultPacket = remotePackageIQ.buildResultPacket(bResult);
              mXmppConnection.sendPacket(resultPacket);
              Log.e(TAG, "Result:" + resultPacket.toXML());
            }
            break;
        case RemotePackageIQ.CMD_INT_DISABLE:{
            String pkgName = cmdArgs.get(0);
            Log.e(TAG, "disable pkg: " + pkgName);
            boolean bResult = mRPM.disablePkgForUser(pkgName,0);
            Packet resultPacket = remotePackageIQ.buildResultPacket(bResult);
            mXmppConnection.sendPacket(resultPacket);
            Log.e(TAG, "Result:" + resultPacket.toXML());
            
            }
            break;
        default:
            break;
        }
        return;
    }
    
    private void handleIQCmd(RemoteDeviceIQ remoteDeviceIQ){
        return;
    }
    
    
    
    
    
   
    
    RemotePkgsManager mRPM = null;
    public void start(RemotePkgsManager rpm){
        if(mXmppConnection == null)
            return;
        mRPM = rpm;
        try {
            mSmackPktListener = new XmppPacketListener();
            mXmppConnection.addPacketListener(mSmackPktListener, new PacketFilter() {
                
                @Override
                public boolean accept(Packet packet) {
                    Log.e(TAG, "accept packet?:" + packet.toXML());
                    if(packet.getXmlns().contains(XMPP_NAMESPACE))
                        return true;
                    return false;
                }
            });
        } catch (Exception e) {
            // TODO: handle exception
            Log.e(TAG, e.getMessage());
        }
        return;
    }*/
    
    
}

